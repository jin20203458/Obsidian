[일정 우선 순위 - Win32 앱 | 마이크로소프트 런](https://learn.microsoft.com/en-us/windows/win32/procthread/scheduling-priorities)
Windows의 스케줄링 방식은 **우선순위 기반 선점형 스케줄링(Priority-Based Preemptive Scheduling)**으로 동작하며, 다중 피드백 큐의 원칙을 적용합니다. 해당 내용은 편의를 위해 요약되었으며, 자세한 내용을 원하면 공식문서를 참조하기 바랍니다.
### **우선순위의 범위**

- 우선순위는 **0에서 31까지**의 값으로 표현됩니다.(31이 가장 높은 우선순위)
    - **0 (최저 우선순위)**: 시스템 스레드인 "Zero-Page Thread"만 사용할 수 있습니다.
        - 해당 스레드는 시스템이 유휴 상태일때만 활성화되며(가장 낮은 우선순위를 가지기에) 사용하지 않는 페이지를 0으로 만드는(초기화)하는 작업을 수행합니다.
         **시스템이 메모리 페이지를 해제 -> 제로 페이지 스레드가 해당 페이지 초기화**


    - **31 (최고 우선순위)**: 가장 중요한 작업을 수행하는 스레드가 사용합니다.

---

### **우선순위에 따른 스레드 스케줄링**

1. **동일 우선순위 스레드 간 동작**:
    
    - 동일한 우선순위를 가진 스레드들은 모두 **동등하게 취급**됩니다.
    - 시스템은 이러한 스레드들에게 **라운드 로빈 방식**으로 CPU 시간을 할당합니다.
        - **라운드 로빈 방식**이란, 각 스레드가 정해진 시간(타임 슬라이스) 동안 순서대로 실행되는 선점형 스케줄링
    - 동일 우선순위에서 실행할 스레드가 없는 경우 다음으로 높은 우선순위를 가진 스레드에 라운드 로빈방식으로 타임슬라이스를 할당합니다. 

1. **다른 우선순위 스레드 간 동작**:
    
    - 더 높은 우선순위를 가진 스레드가 실행 대기 상태가 되면, 시스템은 현재 실행 중인 낮은 우선순위 스레드를 즉시 중단하고, 높은 우선순위 스레드에게 CPU를 할당합니다.
    - 이 경우, 낮은 우선순위 스레드는 남은 실행 시간을 사용하지 못하고 대기 상태로 전환됩니다.

**각 스레드의 우선 순위는 다음 조건에 따라 결정됩니다.**

- 해당 프로세스의 우선 순위 클래스
- 프로세스의 우선 순위 클래스 내에 있는 스레드의 우선 순위 수준입니다
ex)
![[Pasted image 20250116151422.png]]
주의점 : THREAD_PRIORITY_IDLE은 해당 프로세스의 우선순위 최저값으로 세팅됨으로 대부분 1인데 실시간 프로세스 클래스의 경우 최저값이 16이다.

---
### **컨텍스트 스위치 과정**
[Context Switches - Win32 apps | Microsoft Learn](https://learn.microsoft.com/en-us/windows/win32/procthread/context-switches)

1. **현재 실행 중인 스레드의 상태 저장**:
    - 현재 CPU에서 실행 중인 스레드의 상태(레지스터, 스택 등)를 저장합니다.(해당 상태는 PCB에 저장됩니다. : TCB는 TCB를 참조합니다.)
2. **스레드를 우선순위 큐의 끝에 배치**:
    - 현재 실행 중인 스레드는 해당 우선순위 큐의 끝에 위치하게 되며, 나중에 다시 실행되기 위해 대기합니다.(이때 우선순위 큐는 각 우선순위 별 큐를 말합니다. 1레밸큐, 2레밸큐..)
3. **다음 실행할 스레드 선택**:
    - 스케줄러는 준비된 스레드가 있는 가장 높은 우선순위 큐를 찾습니다.
4. **새로운 스레드 실행**:
    - 해당 큐에서 가장 앞에 있는 스레드를 꺼내고, 해당 스레드의 상태를 복구하여 실행을 시작합니다.

컨텍스트 스위칭의 가장 일반적인 이유는 다음과 같습니다.

- 타임슬라이스 초과
- 우선 순위가 더 높은 스레드를 실행할 준비
- IO작업, 동기화 객체등을 대기할때 (사용중인 공유자원에 접근하여 블록되었을때)

---
### Priority Boosts
[Priority Boosts - Win32 apps | Microsoft Learn](https://learn.microsoft.com/en-us/windows/win32/procthread/priority-boosts)

처음 스레드의 우선순위는 기본 우선 순위와 동일합니다. 시스템은 기본 우선순위 수준이 16에서 31 사이인(실시간 프로세스의 범위) 스레드의 우선순위를 높이지 않습니다. 기본 우선순위가 0에서 15 사이인 스레드만 동적 우선 순위 상승을 받습니다.

- NORMAL_PRIORITY_CLASS 사용하는 프로세스를 포그라운드로 가져오면 스케줄러는 포그라운드 창과 연결된 프로세스의 우선 순위 클래스를 높여 백그라운드 프로세스의 우선 순위 클래스보다 크거나 같게 합니다. 우선 순위 클래스는 프로세스가 더 이상 포그라운드에 있지 않을 때 원래 설정으로 돌아갑니다. **(배경 프로세스가 전경으로 나올경우 우선순위 부스트)**

- 창이 타이머 메시지, 마우스 메시지 또는 키보드 입력과 같은 입력을 받으면 스케줄러는 창을 소유하는 스레드의 우선 순위를 높입니다.(**타이머, 키보드 입력등 사용자의 반응이 필요한 상황에 부스트**)

- 차단된 스레드에 대한 대기 조건이 충족되면 스케줄러는 스레드의 우선 순위를 높입니다. 예를 들어 디스크 또는 키보드 I/O와 연결된 대기 작업이 완료되면 스레드는 우선 순위 상승을 받습니다.**(블록되었던 스레드가 복귀할때 우선순위 부스트)**

